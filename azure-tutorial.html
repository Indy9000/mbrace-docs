<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8"/>
    <title>Using MBrace on Windows Azure IaaS
</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <meta name="description" content="An open source framework for large-scale distributed computation and data processing written in F#."/>
    <meta name="author" content="Jan Dzik, Nick Palladinos, Kostas Rontogiannis, Eirik Tsarpalis"/>
    
    <script src="https://code.jquery.com/jquery-1.8.0.js"></script>
    <script src="https://code.jquery.com/ui/1.8.23/jquery-ui.js"></script>
    <script src="https://netdna.bootstrapcdn.com/twitter-bootstrap/2.2.1/js/bootstrap.min.js"></script>
    <link href="https://netdna.bootstrapcdn.com/twitter-bootstrap/2.2.1/css/bootstrap-combined.min.css" rel="stylesheet"/>

    <link rel="icon" type="image/png" href="http://www.m-brace.net/img/favicon-196x196.png" sizes="196x196"/>
    <link rel="icon" type="image/png" href="http://www.m-brace.net/img/favicon-160x160.png" sizes="160x160"/>
    <link rel="icon" type="image/png" href="http://www.m-brace.net/img/favicon-96x96.png" sizes="96x96"/>
    <link rel="icon" type="image/png" href="http://www.m-brace.net/img/favicon-16x16.png" sizes="16x16"/>
    <link rel="icon" type="image/png" href="http://www.m-brace.net/img/favicon-32x32.png" sizes="32x32"/>

    <link type="text/css" rel="stylesheet" href="http://www.m-brace.net/content/style.css" />
    <script type="text/javascript" src="http://www.m-brace.net/content/tips.js"></script>
    <!-- HTML5 shim, for IE6-8 support of HTML5 elements -->
    <!--[if lt IE 9]>
      <script src="https://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
  </head>
  <body>
    <div class="container">
      <div class="masthead">
        <ul class="nav nav-pills pull-right">
          <li><a href="http://nessos.github.io">nessos</a></li>
          <li><a href="http://github.com/mbraceproject/MBrace.Core">github page</a></li>
        </ul>
        <h3 class="muted"><a href="http://www.m-brace.net/index.html">MBrace</a></h3>
      </div>
      <hr />
      <div class="row">
        <div class="span9" id="main">
          
<h1><a name="Using-MBrace-on-Windows-Azure-IaaS" class="anchor" href="#Using-MBrace-on-Windows-Azure-IaaS">Using MBrace on Windows Azure IaaS</a></h1>

<p>In this tutorial you will learn how to setup MBrace on Windows Azure IaaS. 
As a prerequisite you need to have a Windows Azure account, basic knowledge of the Azure computing/virtual machine services and
optionally Microsoft Visual Studio (or any environment supporting F#).</p>

<p>Typically you need some virtual machines to run the MBrace daemons/nodes and a client
that manages the runtime (usually the client runs on a F# interactive instance). Any nodes in a MBrace runtime
as well as any clients, should be part of the same network in order to work properly.</p>

<p>Because of this restriction in this tutorial you have two choices: you can either use one of the virtual machines as a client or you can use
the Windows Azure VPN service to join the virtual network created in Azure and access the runtime from a remote client (your on-premises computer).</p>

<h2><a name="Creating-a-virtual-network" class="anchor" href="#Creating-a-virtual-network">Creating a virtual network</a></h2>

<p>At this point you should decide if you are going to use a remote client or one of
the virtual machines as a client. If you choose the first 
option you need to create a virtual network, create and upload certificates and finally configure your VPN client. 
The process is described in <a href="http://msdn.microsoft.com/en-us/library/azure/dn133792.aspx">here</a>.</p>

<p>You can skip this step if you want to use a client in one of your virtual machines, as a virtual network will be automatically created
for you during the virtual machine creation.</p>

<h2><a name="Creating-a-virtual-machine" class="anchor" href="#Creating-a-virtual-machine">Creating a virtual machine</a></h2>

<p>Now you need to create your virtual machines. You can follow 
<a href="https://azure.microsoft.com/en-us/documentation/articles/virtual-machines-windows-tutorial/">this</a> tutorial
to create a virtual machine (you can skip the 'How to attach a data disk to the new virtual machine' section).
If you have created a virtual network then you <strong>must</strong> specify 
the virtual network when you create the virtual machine. 
You can't join the virtual machine to a virtual network after you have created the VM.</p>

<p>Note that although there are no minimal requirements for the VM size it's recommented to use at least 
a Medium (A2) (2 cores, 3.5GB Memory) instance. After the virtual machine is created log on to it.</p>

<h2><a name="Installing-the-MBrace-and-Configuring-Runtime" class="anchor" href="#Installing-the-MBrace-and-Configuring-Runtime">Installing the MBrace and Configuring Runtime</a></h2>

<p>At this point you need to install MBrace in this machine using the instructions
in our <a href="runtime-deployment.html">Runtime Installation</a> guide.
Follow the <a href="runtime-deployment.html#installservice">Installing the MBrace Runtime Service</a> section to install MBrace as a Windows Service .</p>

<p>Now you need to make any <a href="runtime-deployment.html#configureservice">configurations</a> to the MBrace daemon.</p>

<p>Normally you don't need to change anything and you can skip this step, unless you are using a remote client and a VPN.
In this case you need to change the <code>hostname</code> setting from its default value to the internal IP of the virtual machine 
or the subnet of the previously virtual network in CIDR format.</p>

<table class="pre"><tr><td class="lines"><pre class="fssnip">
<span class="l">1: </span>
</pre>
</td>
<td class="snippet"><pre class="fssnip">
<span class="o">&lt;</span><span class="i">add</span> <span class="i">key</span><span class="o">=</span><span class="s">&quot;hostname&quot;</span> <span class="i">value</span><span class="o">=</span><span class="s">&quot;10.0.1.0/27&quot;</span> <span class="o">/&gt;</span>
</pre>
</td>
</tr>
</table>

<p>Leaving the <em>hostname</em> setting to it's default value means that the runtime will use the machine's
hostname as a node identifier. In the case of VPN your computer (the client) might not be able to
resolve this hostname to an IP (unless you use a DNS server). Using the VM's IP or a subnet instead of its hostname
makes sure that the client will be able to communicate with this node.</p>

<p>You also might want to consider setting the <code>working directory</code> to the temporary disk path (usually <code>D:</code>)
as the increased speed of this drive will reduce the IO time used by the runtime. Note that this drive is
not persistent and, while hardware failure is rare, the data on this disk may be lost. For this reason you
might also want to change the <code>log file</code> setting to a path that is persistent instead of saving the logs to the temporary drive.</p>

<p>After changing the configuration file restart the Windows service.</p>

<h2><a name="Creating-your-cluster" class="anchor" href="#Creating-your-cluster">Creating your cluster</a></h2>

<p>After setting up the first virtual machine you need to replicate it in order to create a cluster of nodes.
You can either create the new virtual machines just like the first one and then install the runtime in each of them,
or you can use the first machine as a template and create your cluster.
For the second option you need to run <code>sysprep</code> on the virtual machine and then create a custom
virtual machine. This process is described <a href="https://azure.microsoft.com/en-us/documentation/articles/virtual-machines-capture-image-windows-server/">here</a>
for the sysprep part and <a href="https://azure.microsoft.com/en-us/documentation/articles/virtual-machines-create-custom/">here</a> for the custom virtual machine creation.
You just need to make sure that during the creation you choose the same <em>Cloud Service</em> and <em>Virtual Network</em> for all of your machines.</p>

<h2><a name="Booting-the-MBrace-Runtime" class="anchor" href="#Booting-the-MBrace-Runtime">Booting the MBrace Runtime</a></h2>

<p>At this point your virtual machines are running and the MBrace nodes are idle.
At your client machine, if you use VPN make sure that you are connected.</p>

<p>Finally according to the <a href="runtime-deployment.html#bootruntime">Booting the MBrace Runtime</a> section
connect to the MBrace nodes:</p>

<table class="pre"><tr><td class="lines"><pre class="fssnip">
<span class="l">1: </span>
</pre>
</td>
<td class="snippet"><pre class="fssnip">
<span class="k">let</span> <span onmouseout="hideTip(event, 'fs4', 11)" onmouseover="showTip(event, 'fs4', 11)" class="i">nodes</span> <span class="o">=</span> [<span class="n">1..</span><span class="n">3</span>] <span class="o">|&gt;</span> <span onmouseout="hideTip(event, 'fs4', 12)" onmouseover="showTip(event, 'fs4', 12)" class="t">List</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs6', 13)" onmouseover="showTip(event, 'fs6', 13)" class="f">map</span> (<span class="k">fun</span> <span onmouseout="hideTip(event, 'fs7', 14)" onmouseover="showTip(event, 'fs7', 14)" class="i">i</span> <span class="k">-&gt;</span> <span onmouseout="hideTip(event, 'fs4', 15)" onmouseover="showTip(event, 'fs4', 15)" class="i">MBraceNode</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs4', 16)" onmouseover="showTip(event, 'fs4', 16)" class="i">Connect</span>(<span onmouseout="hideTip(event, 'fs4', 17)" onmouseover="showTip(event, 'fs4', 17)" class="i">sprintf</span> <span class="s">&quot;clusterVM%d&quot;</span> <span onmouseout="hideTip(event, 'fs4', 18)" onmouseover="showTip(event, 'fs4', 18)" class="i">i</span>, <span class="n">2675</span>))
</pre>
</td>
</tr>
</table>

<p>In case you are using a remote client (without DNS resolution) use the internal IPs of the virtual machines:</p>

<table class="pre"><tr><td class="lines"><pre class="fssnip">
<span class="l">1: </span>
<span class="l">2: </span>
<span class="l">3: </span>
<span class="l">4: </span>
<span class="l">5: </span>
<span class="l">6: </span>
</pre>
</td>
<td class="snippet"><pre class="fssnip">
<span class="k">let</span> <span onmouseout="hideTip(event, 'fs4', 19)" onmouseover="showTip(event, 'fs4', 19)" class="i">nodes</span> <span class="o">=</span>
    [
        <span onmouseout="hideTip(event, 'fs4', 20)" onmouseover="showTip(event, 'fs4', 20)" class="i">MBraceNode</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs4', 21)" onmouseover="showTip(event, 'fs4', 21)" class="i">Connect</span>(<span class="s">&quot;10.0.1.4&quot;</span>, <span class="n">2675</span>)
        <span onmouseout="hideTip(event, 'fs4', 22)" onmouseover="showTip(event, 'fs4', 22)" class="i">MBraceNode</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs4', 23)" onmouseover="showTip(event, 'fs4', 23)" class="i">Connect</span>(<span class="s">&quot;10.0.1.5&quot;</span>, <span class="n">2675</span>)
        <span onmouseout="hideTip(event, 'fs4', 24)" onmouseover="showTip(event, 'fs4', 24)" class="i">MBraceNode</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs4', 25)" onmouseover="showTip(event, 'fs4', 25)" class="i">Connect</span>(<span class="s">&quot;10.0.1.6&quot;</span>, <span class="n">2675</span>)
    ]
</pre>
</td>
</tr>
</table>

<p>Now ping the nodes to ensure connectivity</p>

<table class="pre"><tr><td class="lines"><pre class="fssnip">
<span class="l">1: </span>
</pre>
</td>
<td class="snippet"><pre class="fssnip">
<span onmouseout="hideTip(event, 'fs4', 26)" onmouseover="showTip(event, 'fs4', 26)" class="i">nodes</span> <span class="o">|&gt;</span> <span onmouseout="hideTip(event, 'fs4', 27)" onmouseover="showTip(event, 'fs4', 27)" class="t">List</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs8', 28)" onmouseover="showTip(event, 'fs8', 28)" class="f">iter</span> (<span class="k">fun</span> <span onmouseout="hideTip(event, 'fs9', 29)" onmouseover="showTip(event, 'fs9', 29)" class="i">n</span> <span class="k">-&gt;</span> <span onmouseout="hideTip(event, 'fs4', 30)" onmouseover="showTip(event, 'fs4', 30)" class="f">printfn</span> <span class="s">&quot;Node </span><span class="pf">%A</span><span class="s"> : </span><span class="pf">%s</span><span class="s">&quot;</span> <span onmouseout="hideTip(event, 'fs9', 31)" onmouseover="showTip(event, 'fs9', 31)" class="i">n</span> <span class="o">&lt;|</span> <span class="k">try</span> <span onmouseout="hideTip(event, 'fs9', 32)" onmouseover="showTip(event, 'fs9', 32)" class="i">n</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs4', 33)" onmouseover="showTip(event, 'fs4', 33)" class="i">Ping</span>()<span class="o">.</span><span onmouseout="hideTip(event, 'fs4', 34)" onmouseover="showTip(event, 'fs4', 34)" class="i">ToString</span>() <span class="k">with</span> _ <span class="k">-&gt;</span> <span class="s">&quot;failed&quot;</span>)
</pre>
</td>
</tr>
</table>

<p>At this point we are going to use Windows Azure Storage as our backend. You need
to download the <a href="http://www.nuget.org/packages/MBrace.Azure">MBrace.Azure</a> package.</p>

<p>Now create a new <code>AzureStore</code> and set it as default for your client. 
You can find your storage account name and key using the Azure Management Portal, in the <a href="https://azure.microsoft.com/en-us/documentation/articles/storage-manage-storage-account/#regeneratestoragekeys">Storage</a> page.</p>

<table class="pre"><tr><td class="lines"><pre class="fssnip">
<span class="l"> 1: </span>
<span class="l"> 2: </span>
<span class="l"> 3: </span>
<span class="l"> 4: </span>
<span class="l"> 5: </span>
<span class="l"> 6: </span>
<span class="l"> 7: </span>
<span class="l"> 8: </span>
<span class="l"> 9: </span>
<span class="l">10: </span>
<span class="l">11: </span>
</pre>
</td>
<td class="snippet"><pre class="fssnip">
<span class="prep">#I</span> <span class="s">&quot;../../packages/MBrace.Azure/lib/net45/&quot;</span> 
<span class="prep">#r</span> <span class="s">&quot;MBrace.Azure.dll&quot;</span>

<span class="k">open</span> <span onmouseout="hideTip(event, 'fs4', 35)" onmouseover="showTip(event, 'fs4', 35)" class="i">Nessos</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs4', 36)" onmouseover="showTip(event, 'fs4', 36)" class="i">MBrace</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs4', 37)" onmouseover="showTip(event, 'fs4', 37)" class="i">Azure</span>

<span class="k">let</span> <span onmouseout="hideTip(event, 'fs4', 38)" onmouseover="showTip(event, 'fs4', 38)" class="i">name</span> <span class="o">=</span> <span class="s">&quot;yourStorageAccountName&quot;</span>
<span class="k">let</span> <span onmouseout="hideTip(event, 'fs4', 39)" onmouseover="showTip(event, 'fs4', 39)" class="i">key</span> <span class="o">=</span> <span class="s">&quot;yourStorageAccountKey&quot;</span>

<span class="k">let</span> <span onmouseout="hideTip(event, 'fs4', 40)" onmouseover="showTip(event, 'fs4', 40)" class="i">azureStore</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs4', 41)" onmouseover="showTip(event, 'fs4', 41)" class="i">AzureStore</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs4', 42)" onmouseover="showTip(event, 'fs4', 42)" class="i">Create</span>(<span onmouseout="hideTip(event, 'fs4', 43)" onmouseover="showTip(event, 'fs4', 43)" class="i">accountName</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs4', 44)" onmouseover="showTip(event, 'fs4', 44)" class="i">name</span>, <span onmouseout="hideTip(event, 'fs4', 45)" onmouseover="showTip(event, 'fs4', 45)" class="i">accountKey</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs4', 46)" onmouseover="showTip(event, 'fs4', 46)" class="i">key</span>)

<span onmouseout="hideTip(event, 'fs4', 47)" onmouseover="showTip(event, 'fs4', 47)" class="i">MBraceSettings</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs4', 48)" onmouseover="showTip(event, 'fs4', 48)" class="i">DefaultStore</span> <span class="o">&lt;-</span> <span onmouseout="hideTip(event, 'fs4', 49)" onmouseover="showTip(event, 'fs4', 49)" class="i">azureStore</span>
</pre>
</td>
</tr>
</table>

<p>Finally boot the runtime (the MBrace.Azure package will be uploaded to the runtime)
and send your first cloud computation.</p>

<table class="pre"><tr><td class="lines"><pre class="fssnip">
<span class="l">1: </span>
<span class="l">2: </span>
<span class="l">3: </span>
</pre>
</td>
<td class="snippet"><pre class="fssnip">
<span class="k">let</span> <span onmouseout="hideTip(event, 'fs4', 50)" onmouseover="showTip(event, 'fs4', 50)" class="i">runtime</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs4', 51)" onmouseover="showTip(event, 'fs4', 51)" class="i">MBrace</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs4', 52)" onmouseover="showTip(event, 'fs4', 52)" class="i">Boot</span>(<span onmouseout="hideTip(event, 'fs4', 53)" onmouseover="showTip(event, 'fs4', 53)" class="i">nodes</span>, <span onmouseout="hideTip(event, 'fs4', 54)" onmouseover="showTip(event, 'fs4', 54)" class="i">store</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs4', 55)" onmouseover="showTip(event, 'fs4', 55)" class="i">azureStore</span>)

<span onmouseout="hideTip(event, 'fs4', 56)" onmouseover="showTip(event, 'fs4', 56)" class="i">runtime</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs4', 57)" onmouseover="showTip(event, 'fs4', 57)" class="i">Run</span> &lt;@ <span onmouseout="hideTip(event, 'fs4', 58)" onmouseover="showTip(event, 'fs4', 58)" class="i">cloud</span> { <span class="k">return</span> <span class="n">42</span> } @&gt;
</pre>
</td>
</tr>
</table>

<h2><a name="Useful-references" class="anchor" href="#Useful-references">Useful references</a></h2>

<ul>
<li><a href="runtime-deployment.html">Runtime Installation Guide</a></li>
<li><a href="http://msdn.microsoft.com/en-us/library/azure/dn133792.aspx">Configure a Point-to-Site VPN in the Management Portal</a></li>
<li><a href="https://azure.microsoft.com/en-us/documentation/articles/virtual-machines-windows-tutorial/">Create a Virtual Machine Running Windows Server</a></li>
<li><a href="https://azure.microsoft.com/en-us/documentation/articles/virtual-machines-capture-image-windows-server/">How to Capture a Windows Virtual Machine to Use as a Template</a></li>
<li><a href="https://azure.microsoft.com/en-us/documentation/articles/virtual-machines-create-custom/">How to Create a Custom Virtual Machine</a></li>
<li><a href="http://azure.microsoft.com/en-us/documentation/articles/install-configure-powershell/">How to install and configure Azure PowerShell</a></li>
</ul>

<div class="tip" id="fs1">namespace MBrace</div>
<div class="tip" id="fs2">namespace MBrace.Azure</div>
<div class="tip" id="fs3">namespace MBrace.Azure.Client</div>
<div class="tip" id="fs4"></div>
<div class="tip" id="fs5">val defaultof&lt;&#39;T&gt; : &#39;T<br /><br />Full name: Microsoft.FSharp.Core.Operators.Unchecked.defaultof</div>
<div class="tip" id="fs6">val map : mapping:(&#39;T -&gt; &#39;U) -&gt; list:&#39;T list -&gt; &#39;U list<br /><br />Full name: Microsoft.FSharp.Collections.List.map</div>
<div class="tip" id="fs7">val i : int</div>
<div class="tip" id="fs8">val iter : action:(&#39;T -&gt; unit) -&gt; list:&#39;T list -&gt; unit<br /><br />Full name: Microsoft.FSharp.Collections.List.iter</div>
<div class="tip" id="fs9">val n : obj</div>

        </div>
        <div class="span3">
          <a href="http://www.m-brace.net/index.html">
            <img src="http://www.m-brace.net/img/mbrace.png" alt="F# Project" style="width:150px;margin:10px" />
          </a>
          <ul class="nav nav-list" id="menu" style="margin-top: 20px;">
            <li class="nav-header">MBrace</li>
            <li><a href="http://www.m-brace.net/index.html">Home page</a></li>
            <li class="divider"></li>
            <li><a href="http://www.nuget.org/packages/MBrace.Core">Get Library via NuGet</a></li>
            <li><a href="http://github.com/mbraceproject/MBrace.Core">Source Code on GitHub</a></li>
            <li><a href="http://github.com/mbraceproject/MBrace.Core/blob/master/LICENSE.md">License</a></li>
            <li><a href="http://github.com/mbraceproject/MBrace.Core/blob/master/RELEASE_NOTES.md">Release Notes</a></li>

            <li class="nav-header">Getting Started</li>
            <li><a href="http://www.m-brace.net/runtime-deployment.html">Cluster Deployment Guide</a></li>
            <li><a href="http://www.m-brace.net/azure-tutorial.html">Azure Guide</a></li>
            <li class="divider"></li>
            <li><a target="_blank" href="http://skillsmatter.com/skillscasts/5157-mbrace-large-scale-distributed-computation-with-f">Video presentation</a></li>
            <li><a target="_blank" href="http://www.m-brace.net/mbrace-plos.pdf">PLOS'13 Publication</a></li>

            <li class="nav-header">Documentation</li>
            <li><a href="http://www.m-brace.net/programming-model.html">Programming model</a></li>
            <li><a href="http://www.m-brace.net/client-api.html">Client API</a></li>
            <li><a target="_blank" href="http://www.m-brace.net/mbrace-manual.pdf">MBrace Manual</a></li>
            <li><a href="http://www.m-brace.net/reference/index.html">API Reference</a></li>
          </ul>
        </div>
      </div>
    </div>
    <a href="http://github.com/mbraceproject/MBrace.Core"><img style="position: absolute; top: 0; right: 0; border: 0;" src="https://s3.amazonaws.com/github/ribbons/forkme_right_gray_6d6d6d.png" alt="Fork me on GitHub"/></a>
  </body>
  </html>
